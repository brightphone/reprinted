<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>从 NSObject 的初始化了解 isa</title>
    <meta name="description" content="" />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/reprinted/assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/reprinted/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/reprinted/assets/css/syntax.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="/reprinted//isa" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/reprinted/page2/" />

    <meta property="og:site_name" content="" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="从 NSObject 的初始化了解 isa" />
    <meta property="og:description" content="" />
    <meta property="og:url" content="/reprinted//isa" />
    <meta property="og:image" content="/reprinted/assets/images/cover2.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="从 NSObject 的初始化了解 isa" />
    <meta name="twitter:description" content="" />
    <meta name="twitter:url" content="/reprinted//isa" />
    <meta name="twitter:image:src" content="/reprinted/assets/images/cover2.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "",
    "name": "从 NSObject 的初始化了解 isa",
    "url": "/reprinted//isa",
    "image": "/reprinted/assets/images/cover2.jpg",
    "description": ""
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="" href="/reprinted/feed.xml" />


</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/reprinted/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/reprinted/about">About</a></li>
        <li class="nav-ios " role="presentation"><a href="/reprinted/tag/ios">iOS</a></li>
        <li class="nav-objective-c " role="presentation"><a href="/reprinted/tag/objective-c">objective-c</a></li>
        <li class="nav-swift " role="presentation"><a href="/reprinted/tag/swift">Swift</a></li>
        <li class="nav-others " role="presentation"><a href="/reprinted/tag/others">others</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/reprinted/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/reprinted/assets/images/cover2.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/reprinted/"><img src="/reprinted/assets/images/ghost.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-fiction">

        <header class="post-header">
            <h1 class="post-title">从 NSObject 的初始化了解 isa</h1>
            <section class="post-meta">
            <!-- <a href='/reprinted/'></a> -->

            
                
                    <a href='/reprinted/author/Draveness'>Draveness</a>
                
            
            <time class="post-date" datetime="2016-04-21">21 Apr 2016</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/reprinted/tag/iOS'>iOS</a>,
                    
                
                    
                       <a href='/reprinted/tag/OSS'>OSS</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>Blog: <a href="http://draveness.me">Draveness</a></p>

<iframe src="http://ghbtns.com/github-btn.html?user=draveness&amp;type=follow&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowtransparency="true"></iframe>

<p>关注仓库，及时获得更新：<a href="https://github.com/draveness/iOS-Source-Code-Analyze">iOS-Source-Code-Analyze</a></p>

<blockquote>
  <p>因为 ObjC 的 runtime 只能在 Mac OS 下才能编译，所以文章中的代码都是在 Mac OS，也就是 <code class="highlighter-rouge">x86_64</code> 架构下运行的，对于在 arm64 中运行的代码会特别说明。</p>
</blockquote>

<p>如果你曾经对 ObjC 底层的实现有一定的了解，你应该会知道 <strong>Objective-C 对象都是 C 语言结构体</strong>，所有的对象都包含一个类型为  <code class="highlighter-rouge">isa</code> 的指针，那么你可能确实对 ObjC 的底层有所知，不过现在的 ObjC 对象的结构已经不是这样了。代替 <code class="highlighter-rouge">isa</code> 指针的是结构体 <code class="highlighter-rouge">isa_t</code>, 这个结构体中”包含”了当前对象指向的类的信息，这篇文章中会介绍一些关于这个变化的知识。</p>

<pre><code class="language-objectivec">struct objc_object {
    isa_t isa;
};
</code></pre>

<p>当 ObjC 为为一个对象分配内存，初始化实例变量后，在这些对象的实例变量的结构体中的第一个就是 <code class="highlighter-rouge">isa</code>。</p>

<p><img src="http://7xrlu3.com1.z0.glb.clouddn.com/2016-04-21-NSObject + NSObject Copy + @Draveness.png" alt="NSObject" /></p>

<blockquote>
  <p>所有继承自 <code class="highlighter-rouge">NSObject</code> 的类实例化后的对象都会包含一个类型为 <code class="highlighter-rouge">isa_t</code> 的结构体。</p>
</blockquote>

<p>从上图中可以看出，不只是<strong>实例</strong>会包含一个 <code class="highlighter-rouge">isa</code> 结构体，所有的<strong>类</strong>也有这么一个 <code class="highlighter-rouge">isa</code>。在 ObjC 中 Class 的定义也是一个名为 <code class="highlighter-rouge">objc_class</code> 的结构体，如下：</p>

<pre><code class="language-objectivec">struct objc_class : objc_object {
    isa_t isa;
    Class superclass;
    cache_t cache;
    class_data_bits_t bits;
};
</code></pre>

<blockquote>
  <p>由于 <code class="highlighter-rouge">objc_class</code> 结构体是继承自 <code class="highlighter-rouge">objc_object</code> 的，所以在这里显式地写出了 <code class="highlighter-rouge">isa_t isa</code> 这个成员变量。</p>
</blockquote>

<h2 id="isa-指针的作用与元类"><code class="highlighter-rouge">isa</code> 指针的作用与元类</h2>

<p>到这里，我们就明白了：<strong>Objective-C 中类也是一个对象</strong>。</p>

<p>这个 <code class="highlighter-rouge">isa</code> 包含了什么呢？回答这个问题之前，要引入了另一个概念 <em>元类(meta class)</em>，我们先了解一些关于元类的信息。</p>

<p>因为在 Objective-C 中，对象的方法并<strong>没有存储于对象的结构体中</strong>（如果每一个对象都保存了自己能执行的方法，那么对内存的占用有极大的影响）。</p>

<p>当<strong>实例方法</strong>被调用时，它要通过自己持有的 <code class="highlighter-rouge">isa</code> 来查找对应的类，然后在这里的 <code class="highlighter-rouge">class_data_bits_t</code> 结构体中查找对应方法的实现。同时，每一个 <code class="highlighter-rouge">objc_class</code> 也有一个<strong>指向自己的父类的指针</strong> <code class="highlighter-rouge">super_class</code> 用来查找继承的方法。</p>

<blockquote>
  <p>关于如何在 <code class="highlighter-rouge">class_data_bits_t</code> 中查找对应方法会在之后的文章中讲到。这里只需要知道，它会在这个结构体中查找到对应方法的实现就可以了。</p>
</blockquote>

<p><img src="http://7xrlu3.com1.z0.glb.clouddn.com/2016-04-21-Slice 1.png" alt="Slice 1" /></p>

<p>但是，这样就有一个问题，类方法的实现又是如何查找并且调用的呢？这时，就需要引入<em>元类</em>来保证无论是类还是对象都能<strong>通过相同的机制查找方法的实现</strong>。</p>

<p><img src="http://7xrlu3.com1.z0.glb.clouddn.com/2016-04-21-objc-isa-meta-class.png" alt="objc-isa-meta-class" /></p>

<p>让每一个类的 <code class="highlighter-rouge">isa</code> 指向对应的元类，这样就达到了使类方法和实例方法的调用机制相同的目的：</p>

<ul>
  <li>实例方法调用时，通过对象的 <code class="highlighter-rouge">isa</code> 在类中获取方法的实现</li>
  <li>类方法调用时，通过类的 <code class="highlighter-rouge">isa</code> 在元类中获取方法的实现</li>
</ul>

<p>下面这张图介绍了对象，类与元类之间的关系，笔者认为已经觉得足够清晰了，所以不在赘述。</p>

<p><img src="http://7xrlu3.com1.z0.glb.clouddn.com/2016-04-21-14611715787360.jpg" alt="" /></p>

<blockquote>
  <p>图片来自 <a href="http://www.sealiesoftware.com/blog/archive/2009/04/14/objc_explain_Classes_and_metaclasses.html">objc_explain_Classes_and_metaclasses</a></p>
</blockquote>

<p>有关与介绍类与元类之间的关系的文章实在是太多了，因为这篇文章主要介绍 <code class="highlighter-rouge">isa</code>，在这一小节只是对其作用以及元类的概念进行介绍。如果想要了解更多关于类与元类的信息，可以看 <a href="http://www.cocoawithlove.com/2010/01/what-is-meta-class-in-objective-c.html">What is a meta-class in Objective-C?</a></p>

<h2 id="结构体-isa_t">结构体 <code class="highlighter-rouge">isa_t</code></h2>

<p>其实 <code class="highlighter-rouge">isa_t</code> 是一个定义得非常”奇怪”的结构体，在 ObjC 源代码中可以看到这样的定义：</p>

<pre><code class="language-objectivec">#define ISA_MASK        0x00007ffffffffff8ULL
#define ISA_MAGIC_MASK  0x001f800000000001ULL
#define ISA_MAGIC_VALUE 0x001d800000000001ULL
#define RC_ONE   (1ULL&lt;&lt;56)
#define RC_HALF  (1ULL&lt;&lt;7)

union isa_t {
    isa_t() { }
    isa_t(uintptr_t value) : bits(value) { }

    Class cls;
    uintptr_t bits;

    struct {
        uintptr_t indexed           : 1;
        uintptr_t has_assoc         : 1;
        uintptr_t has_cxx_dtor      : 1;
        uintptr_t shiftcls          : 44;
        uintptr_t magic             : 6;
        uintptr_t weakly_referenced : 1;
        uintptr_t deallocating      : 1;
        uintptr_t has_sidetable_rc  : 1;
        uintptr_t extra_rc          : 8;
    };
};
</code></pre>

<blockquote>
  <p>这是在 <code class="highlighter-rouge">__x86_64__</code> 上的实现，对于 iPhone5s 等架构为 <code class="highlighter-rouge">__arm64__</code> 的设备上，具体结构体的实现和位数可能有些差别，不过这些字段都是存在的，可以看这里的 <a href="#arm64">arm64 上结构体的实现</a></p>
</blockquote>

<p><strong>在本篇文章中, 我们会以 <code class="highlighter-rouge">__x86_64__</code> 为例进行分析，而不会对两种架构下由于不同的内存布局方式导致的差异进行分析</strong>。在我看来，这个细节不会影响对 <code class="highlighter-rouge">isa</code> 指针的理解，不过还是要知道的。</p>

<p>笔者对这个 <code class="highlighter-rouge">isa_t</code> 的实现声明顺序有一些更改，更方便分析和理解。</p>

<pre><code class="language-objectivec">union isa_t {
    ...
};
</code></pre>

<p><code class="highlighter-rouge">isa_t</code> 是一个 <code class="highlighter-rouge">union</code> 类型的结构体，对 <code class="highlighter-rouge">union</code> 不熟悉的读者可以看这个 stackoverflow 上的<a href="http://stackoverflow.com/questions/252552/why-do-we-need-c-unions">回答</a>. 也就是说其中的 <code class="highlighter-rouge">isa_t</code>、<code class="highlighter-rouge">cls</code>、 <code class="highlighter-rouge">bits</code> 还有结构体共用同一块地址空间。而 <code class="highlighter-rouge">isa</code> 总共会占据 64 位的内存空间（决定于其中的结构体）</p>

<p><img src="http://7xrlu3.com1.z0.glb.clouddn.com/2016-04-21-objc-isa-isat.png" alt="objc-isa-isat" /></p>

<pre><code class="language-objectivec">struct {
   uintptr_t indexed           : 1;
   uintptr_t has_assoc         : 1;
   uintptr_t has_cxx_dtor      : 1;
   uintptr_t shiftcls          : 44;
   uintptr_t magic             : 6;
   uintptr_t weakly_referenced : 1;
   uintptr_t deallocating      : 1;
   uintptr_t has_sidetable_rc  : 1;
   uintptr_t extra_rc          : 8;
};
</code></pre>

<h2 id="isa-的初始化"><code class="highlighter-rouge">isa</code> 的初始化</h2>

<p>我们可以通过 <code class="highlighter-rouge">isa</code> 初始化的方法 <code class="highlighter-rouge">initIsa</code> 来初步了解这 64 位的 bits 的作用：</p>

<pre><code class="language-objectivec">inline void
objc_object::initInstanceIsa(Class cls, bool hasCxxDtor)
{
    initIsa(cls, true, hasCxxDtor);
}

inline void
objc_object::initIsa(Class cls, bool indexed, bool hasCxxDtor)
{
    if (!indexed) {
        isa.cls = cls;
    } else {
        isa.bits = ISA_MAGIC_VALUE;
        isa.has_cxx_dtor = hasCxxDtor;
        isa.shiftcls = (uintptr_t)cls &gt;&gt; 3;
    }
}
</code></pre>

<h3 id="indexed-和-magic"><code class="highlighter-rouge">indexed</code> 和 <code class="highlighter-rouge">magic</code></h3>

<p>当我们对一个 ObjC 对象分配内存时，其方法调用栈中包含了上述的两个方法，这里关注的重点是 <code class="highlighter-rouge">initIsa</code> 方法，由于在 <code class="highlighter-rouge">initInstanceIsa</code> 方法中传入了 <code class="highlighter-rouge">indexed = true</code>，所以，我们简化一下这个方法的实现：</p>

<pre><code class="language-objectivec">inline void objc_object::initIsa(Class cls, bool indexed, bool hasCxxDtor)
{
    isa.bits = ISA_MAGIC_VALUE;
    isa.has_cxx_dtor = hasCxxDtor;
    isa.shiftcls = (uintptr_t)cls &gt;&gt; 3;
}
</code></pre>

<p>对整个 <code class="highlighter-rouge">isa</code> 的值 <code class="highlighter-rouge">bits</code> 进行设置，传入 <code class="highlighter-rouge">ISA_MAGIC_VALUE</code>：</p>

<pre><code class="language-objectivec">#define ISA_MAGIC_VALUE 0x001d800000000001ULL
</code></pre>

<p>我们可以把它转换成二进制的数据，然后看一下哪些属性对应的位被这行代码初始化了（标记为红色）：</p>

<p><img src="http://7xrlu3.com1.z0.glb.clouddn.com/2016-04-21-objc-isa-isat-bits.png" alt="objc-isa-isat-bits" /></p>

<p>从图中了解到，在使用 <code class="highlighter-rouge">ISA_MAGIC_VALUE</code> 设置 <code class="highlighter-rouge">isa_t</code> 结构体之后，实际上只是设置了 <code class="highlighter-rouge">indexed</code> 以及 <code class="highlighter-rouge">magic</code> 这两部分的值。</p>

<ul>
  <li>其中 <code class="highlighter-rouge">indexed</code> 表示 <code class="highlighter-rouge">isa_t</code> 的类型
    <ul>
      <li>
        <p>0 表示 <code class="highlighter-rouge">raw isa</code>，也就是没有结构体的部分，访问对象的 <code class="highlighter-rouge">isa</code> 会直接返回一个指向 <code class="highlighter-rouge">cls</code> 的指针，也就是在 iPhone 迁移到 64 位系统之前时 isa 的类型。</p>

        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  union isa_t {
      isa_t() { }
      isa_t(uintptr_t value) : bits(value) { }

      Class cls;
      uintptr_t bits;
  };
</code></pre></div>        </div>
      </li>
      <li>
        <p>1 表示当前 <code class="highlighter-rouge">isa</code> 不是指针，但是其中也有 <code class="highlighter-rouge">cls</code> 的信息，只是其中<strong>关于类的指针都是保存在 <code class="highlighter-rouge">shiftcls</code> 中</strong>。</p>

        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  union isa_t {
      isa_t() { }
      isa_t(uintptr_t value) : bits(value) { }

      Class cls;
      uintptr_t bits;

      struct {
          uintptr_t indexed           : 1;
          uintptr_t has_assoc         : 1;
          uintptr_t has_cxx_dtor      : 1;
          uintptr_t shiftcls          : 44;
          uintptr_t magic             : 6;
          uintptr_t weakly_referenced : 1;
          uintptr_t deallocating      : 1;
          uintptr_t has_sidetable_rc  : 1;
          uintptr_t extra_rc          : 8;
      };
  };
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">magic</code> 的值为 <code class="highlighter-rouge">0x3b</code> 用于调试器判断当前对象是真的对象还是没有初始化的空间</li>
</ul>

<h3 id="has_cxx_dtor"><code class="highlighter-rouge">has_cxx_dtor</code></h3>

<p>在设置 <code class="highlighter-rouge">indexed</code> 和 <code class="highlighter-rouge">magic</code> 值之后，会设置 <code class="highlighter-rouge">isa</code> 的 <code class="highlighter-rouge">has_cxx_dtor</code>，这一位表示当前对象有 C++ 或者 ObjC 的析构器(destructor)，如果没有析构器就会快速释放内存。</p>

<pre><code class="language-objectivec">isa.has_cxx_dtor = hasCxxDtor;
</code></pre>

<p><img src="http://7xrlu3.com1.z0.glb.clouddn.com/2016-04-21-objc-isa-isat-bits-has-css-dtor.png" alt="objc-isa-isat-bits-has-css-dto" /></p>

<h3 id="shiftcls"><code class="highlighter-rouge">shiftcls</code></h3>

<p>在为 <code class="highlighter-rouge">indexed</code>、 <code class="highlighter-rouge">magic</code> 和 <code class="highlighter-rouge">has_cxx_dtor</code> 设置之后，我们就要将当前对象对应的类指针存入 <code class="highlighter-rouge">isa</code> 结构体中了。</p>

<pre><code class="language-objectivec">isa.shiftcls = (uintptr_t)cls &gt;&gt; 3;
</code></pre>

<blockquote>
  <p><strong>将当前地址右移三位的主要原因是用于将 Class 指针中无用的后三位清楚减小内存的消耗，因为类的指针要按照字节（8 bits）对齐内存，其指针后三位都是没有意义的 0</strong>。</p>

  <p>绝大多数机器的架构都是 <a href="https://en.wikipedia.org/wiki/Byte_addressing">byte-addressable</a> 的，但是对象的内存地址必须对齐到字节的倍数，这样可以提高代码运行的性能，在 iPhone5s 中虚拟地址为 33 位，所以用于对齐的最后三位比特为 <code class="highlighter-rouge">000</code>，我们只会用其中的 30 位来表示对象的地址。</p>
</blockquote>

<p>而 ObjC 中的类指针的地址后三位也为 0，在 <code class="highlighter-rouge">_class_createInstanceFromZone</code> 方法中打印了调用这个方法传入的类指针：</p>

<p><img src="http://7xrlu3.com1.z0.glb.clouddn.com/2016-04-21-objc-isa-print-cls.png" alt="objc-isa-print-cls" /></p>

<p>可以看到，这里打印出来的<strong>所有类指针十六进制地址的最后一位都为 8 或者 0</strong>。也就是说，类指针的后三位都为 0，所以，我们在上面存储 <code class="highlighter-rouge">Class</code> 指针时右移三位是没有问题的。</p>

<pre><code class="language-objectivec">isa.shiftcls = (uintptr_t)cls &gt;&gt; 3;
</code></pre>

<p>如果再尝试打印对象指针的话，会发现所有对象内存地址的<strong>后四位</strong>都是 0，说明 ObjC 在初始化内存时是以 16 个字节对齐的, 分配的内存地址后四位都是 0。</p>

<p><img src="http://7xrlu3.com1.z0.glb.clouddn.com/2016-04-21-objc-isa-print-object.png" alt="objc-isa-print-object" /></p>

<blockquote>
  <p>使用整个指针大小的内存来存储 <code class="highlighter-rouge">isa</code> 指针有些浪费，尤其在 64 位的 CPU 上。在 <code class="highlighter-rouge">ARM64</code> 运行的 iOS 只使用了 33 位作为指针(与结构体中的 33 位无关，Mac OS 上为 47 位)，而剩下的 31 位用于其它目的。类的指针也同样根据字节对齐了，每一个类指针的地址都能够被 8 整除，也就是使最后 3 bits 为 0，为 <code class="highlighter-rouge">isa</code> 留下 34 位用于性能的优化。</p>

  <p>Using an entire pointer-sized piece of memory for the isa pointer is a bit wasteful, especially on 64-bit CPUs which don’t use all 64 bits of a pointer. ARM64 running iOS currently uses only 33 bits of a pointer, leaving 31 bits for other purposes. Class pointers are also aligned, meaning that a class pointer is guaranteed to be divisible by 8, which frees up another three bits, leaving 34 bits of the isa available for other uses. Apple’s ARM64 runtime takes advantage of this for some great performance improvements.
from <a href="https://www.mikeash.com/pyblog/friday-qa-2013-09-27-arm64-and-you.html">ARM64 and You</a></p>
</blockquote>

<p>我尝试运行了下面的代码将 <code class="highlighter-rouge">NSObject</code> 的类指针和对象的 <code class="highlighter-rouge">isa</code> 打印出来，具体分析一下</p>

<p><img src="http://7xrlu3.com1.z0.glb.clouddn.com/2016-04-21-objc-isa-print-class-object.png" alt="objc-isa-print-class-object" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>object_pointer: 0000000001011101100000000000000100000000001110101110000011111001 // 补全至 64 位
class_pointer:                                 100000000001110101110000011111000
</code></pre></div></div>

<blockquote>
  <p>编译器对直接访问 <code class="highlighter-rouge">isa</code> 的操作会有警告，因为直接访问 <code class="highlighter-rouge">isa</code> 已经不会返回类指针了，这种行为已经被启用了，取而代之的是使用 <a href="#ISA()">ISA()</a> 方法来获取类指针。</p>
</blockquote>

<p>代码中的 <code class="highlighter-rouge">object</code> 对象的 <code class="highlighter-rouge">isa</code> 结构体中的内容是这样的：</p>

<p><img src="http://7xrlu3.com1.z0.glb.clouddn.com/2016-04-21-objc-isa-isat-class-highlight-bits.png" alt="objc-isa-isat-class-highlight-bits" /></p>

<p>其中红色的为<strong>类指针</strong>，与上面打印出的 <code class="highlighter-rouge">[NSObject class]</code> 指针右移三位的结果完全相同。这也就验证了我们之前对于初始化 <code class="highlighter-rouge">isa</code> 时对 <code class="highlighter-rouge">initIsa</code> 方法的分析是正确的。它设置了 <code class="highlighter-rouge">indexed</code>、<code class="highlighter-rouge">magic</code> 以及 <code class="highlighter-rouge">shiftcls</code>。</p>

<h3 id="isa-方法"><a id="ISA()"></a>ISA() 方法</h3>

<p>因为我们使用结构体取代了原有的 isa 指针，所以要提供一个方法 <code class="highlighter-rouge">ISA()</code> 来返回类指针。</p>

<p>其中 <code class="highlighter-rouge">ISA_MASK</code> 是宏定义，这里通过掩码的方式获取类指针：</p>

<pre><code class="language-objectivec">#define ISA_MASK 0x00007ffffffffff8ULL
inline Class
objc_object::ISA()
{
    return (Class)(isa.bits &amp; ISA_MASK);
}
</code></pre>

<h3 id="其它-bits">其它 bits</h3>

<p>在 <code class="highlighter-rouge">isa_t</code> 中，我们还有一些没有介绍的其它 bits，在这个小结就简单介绍下这些 bits 的作用</p>

<ul>
  <li><code class="highlighter-rouge">has_assoc</code>
    <ul>
      <li>对象含有或者曾经含有关联引用，没有关联引用的可以更快地释放内存</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">weakly_referenced</code>
    <ul>
      <li>对象被指向或者曾经指向一个 ARC 的弱变量，没有弱引用的对象可以更快释放</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">deallocating</code>
    <ul>
      <li>对象正在释放内存</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">has_sidetable_rc</code>
    <ul>
      <li>对象的引用计数太大了，存不下</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">extra_rc</code>
    <ul>
      <li>对象的引用计数超过 1，会存在这个这个里面，如果引用计数为 10，<code class="highlighter-rouge">extra_rc</code> 的值就为 9</li>
    </ul>
  </li>
</ul>

<pre><code class="language-objectivec">struct {
   uintptr_t indexed           : 1;
   uintptr_t has_assoc         : 1;
   uintptr_t has_cxx_dtor      : 1;
   uintptr_t shiftcls          : 44;
   uintptr_t magic             : 6;
   uintptr_t weakly_referenced : 1;
   uintptr_t deallocating      : 1;
   uintptr_t has_sidetable_rc  : 1;
   uintptr_t extra_rc          : 8;
};
</code></pre>

<h3 id="arm64-架构中的-isa_t-结构体"><a id="arm64"></a>arm64 架构中的 <code class="highlighter-rouge">isa_t</code> 结构体</h3>

<pre><code class="language-objectivec">#define ISA_MASK        0x0000000ffffffff8ULL
#define ISA_MAGIC_MASK  0x000003f000000001ULL
#define ISA_MAGIC_VALUE 0x000001a000000001ULL
#define RC_ONE   (1ULL&lt;&lt;45)
#define RC_HALF  (1ULL&lt;&lt;18)
union isa_t {
    isa_t() { }
    isa_t(uintptr_t value) : bits(value) { }

    Class cls;
    uintptr_t bits;

    struct {
       uintptr_t indexed           : 1;
       uintptr_t has_assoc         : 1;
       uintptr_t has_cxx_dtor      : 1;
       uintptr_t shiftcls          : 33;
       uintptr_t magic             : 6;
       uintptr_t weakly_referenced : 1;
       uintptr_t deallocating      : 1;
       uintptr_t has_sidetable_rc  : 1;
       uintptr_t extra_rc          : 19;
    };
};
</code></pre>

<h2 id="参考资料">参考资料</h2>

<ul>
  <li><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtHowMessagingWorks.html">Objective-C Runtime Programming Guide</a></li>
  <li><a href="http://www.cocoawithlove.com/2010/01/what-is-meta-class-in-objective-c.html">What is a meta-class in Objective-C?</a></li>
  <li><a href="http://www.sealiesoftware.com/blog/archive/2009/04/14/objc_explain_Classes_and_metaclasses.html">objc_explain_Classes_and_metaclasses</a></li>
  <li><a href="http://stackoverflow.com/questions/18997362/storing-things-in-isa">Storing things in isa</a></li>
  <li><a href="http://stackoverflow.com/questions/252552/why-do-we-need-c-unions">Why do we need C Unions?</a></li>
  <li><a href="http://www.sealiesoftware.com/blog/archive/2013/09/24/objc_explain_Non-pointer_isa.html">objc_explain_Non-pointer_isa</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Tagged_pointer">Tagged Pointer</a></li>
  <li><a href="https://www.mikeash.com/pyblog/friday-qa-2013-09-27-arm64-and-you.html">ARM64 and You</a></li>
  <li><a href="http://blog.xcodev.com/posts/tagged-pointer-and-64-bit/">64位与Tagged Pointer</a></li>
</ul>

<iframe src="http://ghbtns.com/github-btn.html?user=draveness&amp;type=follow&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowtransparency="true"></iframe>

<p>关注仓库，及时获得更新：<a href="https://github.com/draveness/iOS-Source-Code-Analyze">iOS-Source-Code-Analyze</a></p>

<p>转载请注明  Blog: <a href="http://draveness.me">Draveness</a></p>



        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
                
                    
                        <figure class="author-image">
                            <a class="img" href="/reprinted/author/Draveness" style="background-image: url(/reprinted/assets/images/draven.png)"><span class="hidden">Draveness's Picture</span></a>
                        </figure>
                    

                    <section class="author">
                        <h4><a href="/reprinted/author/Draveness">Draveness</a></h4>

                        
                            <p>Read <a href="/reprinted/author/Draveness">more posts</a> by this author.</p>
                        
                        <div class="author-meta">
                            <span class="author-location icon-location"> Beijing, China</span>
                            <span class="author-link icon-link"><a href="https://draveness.me/index"> draveness.me/index</a></span>
                        </div>
                    </section>

                    <!-- /author  -->

                    <section class="share">
                        <h4>Share this post</h4>
                        <a class="icon-twitter" href="http://twitter.com/share?text=从 NSObject 的初始化了解 isa&amp;url=isa"
                            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span class="hidden">Twitter</span>
                        </a>
                        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=isa"
                            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                            <span class="hidden">Facebook</span>
                        </a>
                        <a class="icon-google-plus" href="https://plus.google.com/share?url=isa"
                           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                            <span class="hidden">Google+</span>
                        </a>
                    </section>
                
            
            <!-- Add Disqus Comments -->
            

        </footer>

    </article>

</main>
<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/reprinted/assets/images/cover2.jpg)" href="/reprinted/method-struct">
            <section class="post">
                <h2>深入解析 ObjC 中方法的结构</h2>
                <p>Blog: [Draveness](http://draveness.me) > 关注仓库，及时获得更新：[iOS-Source-Code-Analyze](https://github.com/draveness/iOS-Source-Code-Analyze) > 因为 ObjC 的 runtime 只能在 Mac OS 下才能编译，所以文章中的代码都是在 Mac OS，也就是...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/reprinted/assets/images/cover2.jpg)" href="/reprinted/afnetworking5">
            <section class="post">
                <h2>验证 HTTPS 请求的证书（五）</h2>
                <p>Blog: Draveness 关注仓库，及时获得更新：iOS-Source-Code-Analyze 自 iOS9 发布之后，由于新特性 App Transport Security 的引入，在默认行为下是不能发送 HTTP 请求的。很多网站都在转用 HTTPS，而 AFNetworking 中的...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/reprinted/"></a> &copy; 2018</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyller/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-69281367-1', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/reprinted/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="/reprinted/assets/js/index.js"></script>

</body>
</html>
