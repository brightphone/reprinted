<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>使用代码为 Xcode 工程添加文件</title>
    <meta name="description" content="" />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/reprinted/assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/reprinted/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/reprinted/assets/css/syntax.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="/reprinted//bei-xcodeproj-keng-de-zhe-ji-tian" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/reprinted/page2/" />

    <meta property="og:site_name" content="" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="使用代码为 Xcode 工程添加文件" />
    <meta property="og:description" content="" />
    <meta property="og:url" content="/reprinted//bei-xcodeproj-keng-de-zhe-ji-tian" />
    <meta property="og:image" content="/reprinted/assets/images/cover2.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="使用代码为 Xcode 工程添加文件" />
    <meta name="twitter:description" content="" />
    <meta name="twitter:url" content="/reprinted//bei-xcodeproj-keng-de-zhe-ji-tian" />
    <meta name="twitter:image:src" content="/reprinted/assets/images/cover2.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "",
    "name": "使用代码为 Xcode 工程添加文件",
    "url": "/reprinted//bei-xcodeproj-keng-de-zhe-ji-tian",
    "image": "/reprinted/assets/images/cover2.jpg",
    "description": ""
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="" href="/reprinted/feed.xml" />


</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/reprinted/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/reprinted/about">About</a></li>
        <li class="nav-ios " role="presentation"><a href="/reprinted/tag/ios">iOS</a></li>
        <li class="nav-objective-c " role="presentation"><a href="/reprinted/tag/objective-c">objective-c</a></li>
        <li class="nav-swift " role="presentation"><a href="/reprinted/tag/swift">Swift</a></li>
        <li class="nav-others " role="presentation"><a href="/reprinted/tag/others">others</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/reprinted/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/reprinted/assets/images/cover2.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/reprinted/"><img src="/reprinted/assets/images/ghost.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-fiction">

        <header class="post-header">
            <h1 class="post-title">使用代码为 Xcode 工程添加文件</h1>
            <section class="post-meta">
            <!-- <a href='/reprinted/'></a> -->

            
                
                    <a href='/reprinted/author/Draveness'>Draveness</a>
                
            
            <time class="post-date" datetime="2015-05-06">06 May 2015</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/reprinted/tag/iOS'>iOS</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>这几天在持续更新 <a href="https://github.com/Draveness/DKNightVersion">DKNightVersion</a> 这个仓库, 我对这个框架投入了很多的时间和精力.</p>

<p>我还是希望把这个框架的方方面面都做好的, 为框架的使用者提供最好的用户体验, 将开发者的使用成本和使用难度降到最低, 提升开发者的使用体验.</p>

<p>但是在我维护这个框架的过程中还是感觉到如何平衡框架的可扩展性和易用性实在是太难了. 为了减少开发者工作量以达到减少错误的目的, 我在这最近几乎每天 8 小时以上的与 xcodeproj 这个文件打交道, 把原来所需的工作尽可能的降低, 从原来的:</p>

<ol>
  <li>ruby generator.rb</li>
  <li>拖拽 UIKit 文件到工作区的指定位置</li>
  <li>选择指定的 Target</li>
</ol>

<p>到现在的一个命令:</p>

<ol>
  <li>rake</li>
</ol>

<p>我也付出了很大的努力, 虽然这个过程看起来非常的简单, 只是<strong>将原来的拖拽改变为使用代码来操作</strong>而已. 但是在实际的操作中, 还是<strong>极其麻烦</strong>的.</p>

<p>麻烦到什么程度呢? 在我每次觉得我要觉得我要成功的时候, 总是会遇到这样那样奇怪的错误或者错误给予我致命一击, 让一切努力都从零开始, 而这种情况在这几天处理这个问题的过程中遇到了 5,6 次.</p>

<p>我很多次都是想过要放弃实现这个功能, 不过到最后, 我还是完成了.</p>

<blockquote>
  <p>很大一部分原因是无法容忍作品中的不完美, 如果我没有想到它, 可能不会去做, 但是既然我想到了这个减少工作量的办法, 而且已经有先例(Cocoapods)完成了, 那么我也一定要实现这个功能.</p>
</blockquote>

<p>而到现在, 我觉得需要写一篇博客记录一下这个过程, 既能够为后人带来一些启发也能少走一些弯路.</p>

<h2 id="xcode-做了什么">Xcode 做了什么</h2>

<p>因为 DKNightVersion 使用了 Ruby 脚本来生成 Objective-C 代码, 而在代码生成之后, 文件虽然会出现在你文件夹之中, 但是并不会直接添加到你的工程文件中, 也就是<strong>编译器不知道你需要这些文件</strong>.</p>

<p>我们一般都是通过拖拽来把这些文件添加到工程中合适的位置, 让编译器 Xcode 知道: <strong>我需要这些文件, 帮我”编译”它们</strong>. 这就是你在拖拽的过程中, Xcode 实际上做的事情.</p>

<p>在拖拽的过程中, 它实际上就是改变了一个神奇的文件 <code class="highlighter-rouge">pbxproj</code>, 这个文件在你的 <code class="highlighter-rouge">xcodeproj</code> <strong>目录</strong>中, 你需要右键点击 <code class="highlighter-rouge">xcodeproj</code> 文件</p>

<p><img src="/content/images/2015/05/E471A4A7-223C-4958-8A02-82CE1B7A6AF6.png" alt="" /></p>

<p>然后会出现这样的菜单, 选中显示包内容</p>

<p><img src="/content/images/2015/05/47DDA965-DBB2-45A8-B8C1-1A0DC5EDE4AE.png" alt="" /></p>

<p>然后你就会看到一个 <code class="highlighter-rouge">project.pbxproj</code> 文件, 而你对文件进行的操作, <strong>添加和删除</strong>实际上都是对这个文件的修改.</p>

<p>如果你长期使用命令行, 你就会非常自然的发现 <code class="highlighter-rouge">*.xcodeproj</code> <code class="highlighter-rouge">*.xcodeworkspace</code> 实际上都是文件夹, 但是后者并不是我们今天所要关心的问题.</p>

<p><img src="/content/images/2015/05/AA8E09AC-864A-46D6-A794-6D2547858CA8.png" alt="" /></p>

<p>我是怎么知道的呢, 我通过反复的尝试, 再删除一些文件的 <code class="highlighter-rouge">refernece</code>(没有将文件移到垃圾桶), 然后使用 <code class="highlighter-rouge">git diff</code> 查看所做的修改, 就会发现其他的文件并没有被修改, <strong>唯一被修改的就是这个 <code class="highlighter-rouge">project.pbxproj</code> 文件</strong>.</p>

<ul>
  <li>在我们进行文件的<strong>增加和删除(不包括修改)</strong>的过程中, 实际上就是对 <code class="highlighter-rouge">project.pbxproj</code> 的修改.</li>
</ul>

<h1 id="向-xcode-工程中添加或删除文件">向 Xcode 工程中添加或删除文件</h1>

<p>如何在非 GUI 中完成对 Xcode 工程文件的操作呢? 我总共进行了三种不同的尝试.</p>

<h2 id="手搓">手搓</h2>

<p>作为一个<del>闲的蛋疼</del>专业的工程师, 我的第一想法是, 这需求肯定很多, 干脆造一个轮子好了, 于是我打开了 <code class="highlighter-rouge">project.pbxproj</code> 文件. 立刻被里面的数据所淹没了.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* Begin PBXBuildFile section */
		0DFDC45E10D450EE9CA10394 /* UITableViewCell+BackgroundColor.h in Headers */ = {isa = PBXBuildFile; fileRef = A9EE3067770E740BB65F5B9D /* UITableViewCell+BackgroundColor.h */; };
		186AC5221AF855410095ED95 /* DKNightVersionManagerTest.m in Sources */ = {isa = PBXBuildFile; fileRef = 186AC5211AF855410095ED95 /* DKNightVersionManagerTest.m */; };
		18D2288D1AF8BA4F00872BF1 /* UINavigationBar+Animation.m in Sources */ = {isa = PBXBuildFile; fileRef = 18D2288C1AF8BA4F00872BF1 /* UINavigationBar+Animation.m */; };
</code></pre></div></div>

<p>七百多行的文件, 我在这里只选取了三行. 因为这个文件中的<strong>数据</strong>实在是太多了. 你会看到每一行的前面大概都是一个 <strong>24 位的 16 进制数字</strong> 然后就是一个文件名 <code class="highlighter-rouge">UITableViewCell+BackgroundColor.h</code> 在最后有一个 <code class="highlighter-rouge">isa</code> 和一个 <code class="highlighter-rouge">fileRef</code>.</p>

<p>在大概浏览了一下这个文件的全部内容之后, 我对于手搓这个 script 有了一个初步的想法, 第一步就是生成这个 <strong>24 位的 16 进制数字</strong>. 当然我希望知道苹果是如何生成这一 16 进制数字的.</p>

<p>(<strong>注: 我实在无法对这个文件中的任何一部分进行详尽的解释, 不过之后我会介绍几个重要的相关概念</strong>)</p>

<p>然而我没有找到相关的资料, 而我自己也没有这个能力来推导出这个神奇的数字是如何生成的.</p>

<h2 id="使用-xcodeproj">使用 <code class="highlighter-rouge">Xcodeproj</code></h2>

<p><a href="https://github.com/CocoaPods/Xcodeproj">Xcodeproj</a> 是一个使用 Ruby 来创建和修改 Xcode 工程文件的工具. 我找到它的原因是 Cocoapods 也通过 Ruby 代码向 Xcode 工程中添加文件, 所以我在 Cocoapods 中找到了这一组件.</p>

<p>在最开始尝试使用这个工具的时候, 发现它的文档是<strong>极其</strong>糟糕. 根本无法直接在文档找到<strong>向 Xcode 工程中添加文件的方法</strong>, 这一简单的需求并没有明确的写在文档中, 这令我十分的不理解.</p>

<p>这个组件的主要功能不就是向工程中添加文件么? 为什么没有写在文档中, 而我所做的就是不断的阅读这个组件的源代码, 尝试理解 <code class="highlighter-rouge">project.pbxproj</code> 中的东西到底都是什么. 而在这期间, 有几个非常重要的问题需要我们理解.</p>

<ul>
  <li>Target</li>
  <li>Group</li>
  <li>FileRef</li>
</ul>

<h4 id="target">Target</h4>

<p><code class="highlighter-rouge">Target</code> 到底是什么, 我在以前的 iOS 开发的工作中并没有仔细地考虑这一个问题, 直到我遇到这一<strong>需求</strong>时, 我在尝试理解这背后的意义.</p>

<blockquote>
  <p>A target specifies a product to build and contains the instructions for building the product from a set of files in a project or workspace. A target defines a single product; it organizes the inputs into the build system—the source files and instructions for processing those source files—required to build that product. Projects can contain one or more targets, each of which produces one product.</p>
</blockquote>

<p><a href="https://developer.apple.com/library/ios/featuredarticles/XcodeConcepts/Concept-Targets.html">Target</a> 指定了一个用于产品(product), 并且包含了从工程中的一些文件中构建产品的命令.</p>

<p>这些命令使用构建设置(build settings)和构建阶段(build phases)的方式来组织, 我们可以在 Xcode 编辑器中改变这些设置.</p>

<h4 id="group">Group</h4>

<p>Group 这个概念和我们平时经常说的 folder 文件夹有很大的差别, 文件夹在我们的日常使用时是一直所接触到的, 而对于 Group, 如果你不使用 Xcode 来编程(不是很清楚别的 IDE 是否有这个功能)的话, 这个概念距离你太远了.</p>

<p>Group 其实是 Xcode 中用来组织文件的一种方式, <strong>它对文件系统没有任何影响</strong>, 无论你创建或者删除一个 Group, 都不会导致 folder 的增加或者移除. 当然如果在你删除时选择 Move to Trash 就是另外一说了.</p>

<p>在 Group 中的文件的关系, 不会与 folder 中的有什么冲突, 它只是 Xcode 为你提供的一种分离关注的方式而已. 但是, 我一般会在开发过程中将不同的模块分到不同的 Group 和 folder 中便于整理.</p>

<p>Group 之间的关系, 也是在 <code class="highlighter-rouge">project.pbxproj</code> 中定义的, 这个文件中包含了 Xcode 工程中所有 File 和 Group 的关系, 如果你大致浏览过这个文件的话, 你就会对我所说的有所了解.</p>

<p>Group 在我们的工程中就是黄色的文件夹, 而 Folder 是蓝色的文件夹(一般在 Xcode 工程中, 我们不会使用 Folder).</p>

<h4 id="fileref">FileRef</h4>

<p>FileRef 其实就是 File Reference 的缩写, 当你从 Xcode 中删除一个文件的时候, 它会弹出这样的提示框.</p>

<p><img src="/content/images/2015/05/77DF33A1-B29F-4294-8860-9D638A95333A.png" alt="" /></p>

<p>而其中的 <code class="highlighter-rouge">Remove Reference</code> 选项并不会将这个文件移除到垃圾桶, 而只是会将这个文件的引用从 Xcode 的工程文件中删除.</p>

<p>如果你曾经看过 <code class="highlighter-rouge">Build Phases</code> 中的内容, 你会发现</p>

<ul>
  <li>如果删除的是 <code class="highlighter-rouge">.h</code> 文件, 它会从 <code class="highlighter-rouge">Build Phases</code> 中的 <strong>Headers</strong> 部分删除</li>
  <li>如果删除的是 <code class="highlighter-rouge">.m</code> 文件, 它会从 <code class="highlighter-rouge">Build Phases</code> 中的 <strong>Compile Source</strong> 部分删除</li>
</ul>

<p>但是文件还是会在原来的地方, 因为 Xcode 中所加入到工程的只是文件的一个引用 — File Ref.</p>

<h3 id="添加文件">添加文件</h3>

<p>我们已经基本了解了阅读这一篇博客所需要的全部知识, 接下来, 我们就需要来分析一下向 Xcode 工程中添加文件所需要的几个步骤.</p>

<p>当我们生成一堆 Objective-C 代码时, 我们的第一步是要将这些文件拖入 Xcode 工程中, 这时 Xcode 会弹出视图询问你是创建 Groups 还是 Folder references, 并询问你要加入到哪个 Target 中.</p>

<p><img src="/content/images/2015/05/04217493-910E-4E6E-BF6E-B0CEE86D3CFB.png" alt="" /></p>

<ul>
  <li>当选择创建 Groups 时,  Xcode 就会把 .h 文件加入 Build Phases 中的 Header, 把 .m 文件加入 Compile Sources 中, 并创建一个黄色的文件夹.</li>
  <li>当选择创建 Folder references 时, Xcode 会把所有的文件加入 Build Phases 中的 Copy Bundles Resources, 不进行任何的编译, 然后创建一个蓝色的文件夹.</li>
</ul>

<p>我们现在就来使用代码来模拟将文件加入 Xcode 中, 选择 Create Groups 并且添加到指定 Target 的全过程.</p>

<p>在这里我们需要使用 Ruby 的开源框架 <a href="https://github.com/CocoaPods/Xcodeproj">xcodeproj</a> 这个框架是著名的开源框架 Cocoapods 的一个组件.</p>

<blockquote>
  <p>Create and modify Xcode projects from Ruby.</p>
</blockquote>

<h4 id="查找-xcodeproj-文件">查找 <code class="highlighter-rouge">*.xcodeproj</code> 文件</h4>

<p><a href="https://github.com/CocoaPods/Xcodeproj/blob/master/lib/xcodeproj/project.rb">lib/xcodeproj/project.rb</a></p>

<p>在使用 xcodeproj 时, 只需要<strong>查找 <code class="highlighter-rouge">*.xcodeproj</code> 文件</strong>而不是 <code class="highlighter-rouge">*.pbxproj</code>. 我们通过调用 <code class="highlighter-rouge">Project</code> 的类方法来打开文件.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">project</span> <span class="o">=</span> <span class="no">Xcodeproj</span><span class="o">::</span><span class="no">Project</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="获取-target">获取 Target</h4>

<p><a href="https://github.com/CocoaPods/Xcodeproj/blob/master/lib/xcodeproj/project.rb">lib/xcodeproj/project.rb</a></p>

<p>接下来要获取 Target, 模拟选择 <code class="highlighter-rouge">Add to targets</code> 这一操作, 在每一个 Project 中都有多个 Target.</p>

<p>一般在我们的项目中, 一般都有一个以 <code class="highlighter-rouge">项目名</code> 和一个以 <code class="highlighter-rouge">项目名+Test</code> 命名的 Target.</p>

<p>Tips:</p>

<ul>
  <li>在 Pod 项目中, 每一个 Pod 都会对应一个 Target, 然后会有一个 <code class="highlighter-rouge">Pods-项目名</code> Target.</li>
</ul>

<p><img src="/content/images/2015/05/1BF77D9B-8D05-4FFA-9A87-0DC73FF7EA52.png" alt="" /></p>

<p>而在这里我想要获得的就是以项目名命名的 Target, 一般都是 <code class="highlighter-rouge">targets</code> 数组中的第一个.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">target</span> <span class="o">=</span> <span class="n">project</span><span class="p">.</span><span class="nf">targets</span><span class="p">.</span><span class="nf">first</span>
</code></pre></div></div>

<h4 id="创建-group">创建 Group</h4>

<p><a href="https://github.com/CocoaPods/Xcodeproj/blob/master/lib/xcodeproj/project/object/group.rb">lib/xcodeproj/project/object/group.rb</a></p>

<p>在获取 Target 之后, 需要创建或者获取一个文件即将被添加进去的 <code class="highlighter-rouge">group</code>, 我一般使用 <code class="highlighter-rouge">find_subpath</code> 这个方法</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">find_subpath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">should_create</span> <span class="o">=</span> <span class="kp">false</span><span class="p">)</span>
</code></pre></div></div>

<p>它能比较快捷的根据路径名寻找 <code class="highlighter-rouge">group</code>, 如果当前的 <code class="highlighter-rouge">group</code> 不存在, 它还会递归地创建(可选).</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">group</span> <span class="o">=</span> <span class="n">project</span><span class="p">.</span><span class="nf">main_group</span><span class="p">.</span><span class="nf">find_subpath</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'DKNightVersion'</span><span class="p">,</span> <span class="s1">'Pod'</span><span class="p">,</span> <span class="s1">'Classes'</span><span class="p">,</span> <span class="s1">'UIKit'</span><span class="p">),</span> <span class="kp">true</span><span class="p">)</span>
</code></pre></div></div>

<p>因为这个方法是一个 <code class="highlighter-rouge">group</code> 的实例方法, 所以先通过 <code class="highlighter-rouge">main_group</code> 获取主 <code class="highlighter-rouge">group</code>, 然后再调用这个方法, 最后会返回指定的 <code class="highlighter-rouge">group</code>. 在工程中创建这样一种的结构.</p>

<p><img src="/content/images/2015/05/508108E0-0EF4-4A8B-8A80-5D2CA5208D58.png" alt="" /></p>

<p>在成功获取之后还<strong>需要把 <code class="highlighter-rouge">group</code> 的 <code class="highlighter-rouge">source_tree</code> 设置成 <code class="highlighter-rouge">'SOURCE_ROOT'</code></strong>, 这样在加入到 Build Phases 的时候, 它会从工程文件的根目录下开始寻找你所添加的文件, 不会出现一些非常奇怪的问题.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">group</span><span class="p">.</span><span class="nf">set_source_tree</span><span class="p">(</span><span class="s1">'SOURCE_ROOT'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="向-group-中添加文件">向 <code class="highlighter-rouge">group</code> 中添加文件</h3>

<p><a href="https://github.com/CocoaPods/Xcodeproj/blob/master/lib/xcodeproj/project/object/group.rb">lib/xcodeproj/project/object/group.rb</a></p>

<p>我们在获取 <code class="highlighter-rouge">group</code> 之后就可以向其中添加文件了. 在这时使用 <code class="highlighter-rouge">new_reference</code> 方法, 为文件创建一个 <code class="highlighter-rouge">FileRef</code> 添加到 <code class="highlighter-rouge">group</code> 中.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">file_ref</span> <span class="o">=</span> <span class="n">group</span><span class="p">.</span><span class="nf">new_reference</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</code></pre></div></div>

<p>这样这个文件就添加到了 <code class="highlighter-rouge">group</code> 中, 会出现在工程中的导航栏中.</p>

<p>但是这个文件并没有被添加到 <code class="highlighter-rouge">Build Phases</code> 中, 无论你是编译还是作为资源来使用, Xcode 都会提示你无法找到这个文件. 我们还需要把这个文件加入到 <code class="highlighter-rouge">Build Phases</code> 中.</p>

<h3 id="将文件加入-build-phases">将文件加入 <code class="highlighter-rouge">Build Phases</code></h3>

<p><a href="https://github.com/CocoaPods/Xcodeproj/blob/master/lib/xcodeproj/project/object/native_target.rb">lib/xcodeproj/project/object/native_target.rb</a></p>

<p>在前面获取到的 <code class="highlighter-rouge">Target</code> 在这一步就开始起了作用, 我们需要获取 <code class="highlighter-rouge">Target</code> 的 <code class="highlighter-rouge">Build Phase</code> 并将在上面添加的文件添加到 <code class="highlighter-rouge">Build Phase</code> 中.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">target</span><span class="p">.</span><span class="nf">add_file_references</span><span class="p">([</span><span class="n">file_ref</span><span class="p">])</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">add_file_references</code> 就负责把一组 <code class="highlighter-rouge">FileRef</code> 添加到对应的 <code class="highlighter-rouge">Build Phases</code> 中, <code class="highlighter-rouge">source_build_phase</code> <code class="highlighter-rouge">headers_build_phase</code> <code class="highlighter-rouge">resource_build_phase</code> <code class="highlighter-rouge">framework_build_phase</code> 在 GUI 中你可以找到这四者对应的 section.</p>

<p>而 <code class="highlighter-rouge">add_file_references</code> 方法自动为你把 <code class="highlighter-rouge">FileRef</code> 添加到合适的 phase 中.</p>

<p>但是从 <code class="highlighter-rouge">Build Phase</code> 中移除文件就需要手动获取这些 <code class="highlighter-rouge">*_build_phase</code> 然后从中调用 <code class="highlighter-rouge">remove_reference</code> 来删除文件或者资源.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">target</span><span class="p">.</span><span class="nf">source_build_phase</span><span class="p">.</span><span class="nf">remove_file_reference</span><span class="p">(</span><span class="n">file_ref</span><span class="p">)</span>
<span class="n">target</span><span class="p">.</span><span class="nf">headers_build_phase</span><span class="p">.</span><span class="nf">remove_file_refernece</span><span class="p">(</span><span class="n">file_ref</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="保存-project">保存 Project</h4>

<p>在最后, 我们只需要调用 <code class="highlighter-rouge">save</code> 方法来保存整个工程就好了.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">project</span><span class="p">.</span><span class="nf">save</span>
</code></pre></div></div>

<h2 id="总结">总结</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">project</span> <span class="o">=</span> <span class="no">Xcodeproj</span><span class="o">::</span><span class="no">Project</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">project</span><span class="p">.</span><span class="nf">targets</span><span class="p">.</span><span class="nf">first</span>
<span class="n">group</span> <span class="o">=</span> <span class="n">project</span><span class="p">.</span><span class="nf">main_group</span><span class="p">.</span><span class="nf">find_subpath</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'DKNightVersion'</span><span class="p">,</span> <span class="s1">'Pod'</span><span class="p">,</span> <span class="s1">'Classes'</span><span class="p">,</span> <span class="s1">'UIKit'</span><span class="p">),</span> <span class="kp">true</span><span class="p">)</span>
<span class="n">group</span><span class="p">.</span><span class="nf">set_source_tree</span><span class="p">(</span><span class="s1">'SOURCE_ROOT'</span><span class="p">)</span>
<span class="n">file_ref</span> <span class="o">=</span> <span class="n">group</span><span class="p">.</span><span class="nf">new_reference</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<span class="n">target</span><span class="p">.</span><span class="nf">add_file_references</span><span class="p">([</span><span class="n">file_ref</span><span class="p">])</span>
<span class="n">project</span><span class="p">.</span><span class="nf">save</span>
</code></pre></div></div>

<p>其实到现在为止, 我感觉到使用代码向 Xcodeproj 中添加文件是很简单的事情, 那是因为, 首先有 Xcodeproj 这样文档糟糕但是功能还是比较齐全的第三方框架, 而且这是我在几天不停地阅读源代码, 不停被坑, 一点一点尝试才摸索出来的结果, 都是泪啊…不想多说了…不过最后把这个问题解决之后, <del>自我感觉还是蛮好的</del>还是挺高兴的. 嗯, 就这样.</p>



        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
                
                    
                        <figure class="author-image">
                            <a class="img" href="/reprinted/author/Draveness" style="background-image: url(/reprinted/assets/images/draven.png)"><span class="hidden">Draveness's Picture</span></a>
                        </figure>
                    

                    <section class="author">
                        <h4><a href="/reprinted/author/Draveness">Draveness</a></h4>

                        
                            <p>Read <a href="/reprinted/author/Draveness">more posts</a> by this author.</p>
                        
                        <div class="author-meta">
                            <span class="author-location icon-location"> Beijing, China</span>
                            <span class="author-link icon-link"><a href="https://draveness.me/index"> draveness.me/index</a></span>
                        </div>
                    </section>

                    <!-- /author  -->

                    <section class="share">
                        <h4>Share this post</h4>
                        <a class="icon-twitter" href="http://twitter.com/share?text=使用代码为 Xcode 工程添加文件&amp;url=bei-xcodeproj-keng-de-zhe-ji-tian"
                            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span class="hidden">Twitter</span>
                        </a>
                        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=bei-xcodeproj-keng-de-zhe-ji-tian"
                            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                            <span class="hidden">Facebook</span>
                        </a>
                        <a class="icon-google-plus" href="https://plus.google.com/share?url=bei-xcodeproj-keng-de-zhe-ji-tian"
                           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                            <span class="hidden">Google+</span>
                        </a>
                    </section>
                
            
            <!-- Add Disqus Comments -->
            

        </footer>

    </article>

</main>
<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/reprinted/assets/images/cover2.jpg)" href="/reprinted/dknightversion-de-shi-xian-wei-ios-ying-yong-tian-jia-ye-jian-mo-shi">
            <section class="post">
                <h2>DKNightVersion 的实现 --- 如何为 iOS 应用添加夜间模式</h2>
                <p>**最新: [成熟的夜间模式解决方案](http://draveness.me/night)** **注意: 这篇文章已经过时了, 最新版本的 2.3.0 实现已经更改了.** 在很多重阅读或者需要在夜间观看的软件其实都会把夜间模式当做一个 App 所需要具备的特性. 而如何在不改变原有的架构, 甚至不改变原有的代码的基础上, 就能为应用优雅地添加夜间模式就成为一个在很多应用开发的过程中不得不面对的一个问题. 就是以上事情的驱动, 使我思考如何才能使用一种优雅并且简洁的方法解决这一问题....</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/reprinted/assets/images/cover2.jpg)" href="/reprinted/cheng-xu-yuan-xiu-lian-zhi-dao-tips">
            <section class="post">
                <h2>程序员修炼之道 Tips</h2>
                <p>这一篇文章其实就是记录程序员修炼之道中的所有 Tips, 我讲会在之后的每周实践两个 Tip, 并对这两个 Tips 进行补充和说明自己的体会, 最终成为书中所说的卓有成效的程序员. Tip 1: Care About Your Craft 关心你的技艺...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/reprinted/"></a> &copy; 2018</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyller/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-69281367-1', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/reprinted/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="/reprinted/assets/js/index.js"></script>

</body>
</html>
